---
# Fleet Universal Pipeline
# Randomly assigns region and generates mixed data types
#
# Usage:
#   expanso-edge run pipelines/fleet-universal.yaml
#
# Or with docker compose:
#   docker compose up -d --scale edge=6

name: fleet-universal-pipeline
type: pipeline

config:
  input:
    generate:
      interval: ${EMIT_INTERVAL:500ms}
      mapping: |
        # Random region assignment (roughly equal distribution)
        let regions = ["us", "eu", "apac"]
        let region = $regions.index(random_int(max: 3))

        # Generate hostname based on region
        let node_id = random_int(min: 1, max: 99)
        let node_name = "edge-%s-%02d".format($region, $node_id)

        # Random data type distribution
        let type_roll = random_int(max: 100)

        root = if $type_roll < 60 {
          # 60% web traffic
          let methods = ["GET", "GET", "GET", "POST", "PUT"]
          let paths = ["/api/users", "/api/orders", "/login", "/health", "/search"]
          let statuses = [200, 200, 200, 201, 400, 404, 500]
          let ips = ["192.168.1.100", "10.0.0.50", "172.16.0.1", "8.8.8.8"]

          {
            "_raw": "%s - - [%s] \"%s %s HTTP/1.1\" %s %s".format(
              $ips.index(random_int(max: 4)),
              now().ts_strftime("%d/%b/%Y:%H:%M:%S -0800"),
              $methods.index(random_int(max: 5)),
              $paths.index(random_int(max: 5)),
              $statuses.index(random_int(max: 7)).string(),
              random_int(min: 100, max: 50000).string()
            ),
            "sourcetype": "access_combined",
            "source": "/var/log/httpd/access_log"
          }
        } else if $type_roll < 75 {
          # 15% errors
          let levels = ["warn", "error", "crit"]
          let messages = [
            "Failed login attempt from suspicious IP",
            "SSL certificate expiring soon",
            "Rate limit exceeded for client",
            "Connection timeout to backend"
          ]

          {
            "_raw": "[%s] [%s] %s".format(
              now().ts_strftime("%d/%b/%Y:%H:%M:%S -0800"),
              $levels.index(random_int(max: 3)),
              $messages.index(random_int(max: 4))
            ),
            "sourcetype": "apache_error",
            "source": "/var/log/httpd/error_log"
          }
        } else if $type_roll < 90 {
          # 15% syslog
          let messages = [
            "Service started successfully",
            "Configuration reloaded",
            "Backup completed",
            "User session timeout"
          ]

          {
            "_raw": "<%s>%s %s daemon[%s]: %s".format(
              random_int(max: 191).string(),
              now().ts_strftime("%b %d %H:%M:%S"),
              $node_name,
              random_int(min: 1000, max: 9999).string(),
              $messages.index(random_int(max: 4))
            ),
            "sourcetype": "syslog",
            "source": "/var/log/messages"
          }
        } else {
          # 10% metrics
          {
            "_raw": {
              "host": $node_name,
              "cpu_pct": random_int(min: 5, max: 95),
              "memory_mb": random_int(min: 1000, max: 7500),
              "disk_pct": random_int(min: 20, max: 80)
            }.format_json(),
            "sourcetype": "metrics:host",
            "source": "collectd"
          }
        }

        root.host = $node_name
        root.region = $region

  pipeline:
    processors:
      - bloblang: |
          # Route by sourcetype to appropriate index
          meta "index" = match this.sourcetype {
            "access_combined" => "web",
            "apache_error" => "security",
            "metrics:host" => "metrics",
            _ => "os"
          }

          meta "region" = this.region
          meta "sourcetype" = this.sourcetype
          meta "host" = this.host
          meta "source" = this.source
          root = this

  output:
    http_client:
      url: ${SPLUNK_HEC_US:http://localhost:8088}/services/collector/event
      verb: POST
      headers:
        Authorization: "Splunk ${SPLUNK_HEC_TOKEN:changeme}"
        Content-Type: application/json
      timeout: 5s
      retries: 3
      processors:
        - bloblang: |
            root.event = this._raw
            root.time = now().ts_unix()
            root.host = meta("host")
            root.source = meta("source")
            root.sourcetype = meta("sourcetype")
            root.index = meta("index")
            root.fields.region = meta("region")
