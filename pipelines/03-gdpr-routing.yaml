---
# Scenario C: GDPR Compliance Routing
# Geographic routing enforced at the edge
# EU data with PII stays in EU storage
#
# Usage (local):
#   docker compose up -d --scale edge=3
#   tail -f logs/us_main.log logs/eu_main.log

name: gdpr-routing-pipeline
type: pipeline

config:
  input:
    generate:
      interval: 500ms
      count: 0
      mapping: |
        # Seed with nanosecond timestamp for unique randoms per message
        let seed = now().ts_unix_nano()

        # Randomly assign region: 40% US, 40% EU, 20% APAC
        let region_roll = random_int(seed: $seed, max: 100)
        let region = if $region_roll < 40 { "us" } else if $region_roll < 80 { "eu" } else { "apac" }

        # Regional IP pools
        let us_ips = ["192.168.1.100", "10.0.0.50", "172.16.0.1"]
        let eu_ips = ["10.20.30.40", "172.20.0.100", "192.168.50.25"]
        let apac_ips = ["10.50.0.100", "172.50.0.50", "192.168.100.1"]

        let ips = if $region == "eu" { $eu_ips }
          else if $region == "apac" { $apac_ips }
          else { $us_ips }

        let ip = $ips.index(random_int(seed: $seed, max: 2))

        # Simulate user activity (some with PII)
        let has_user = random_int(seed: $seed, max: 100) > 60
        let user_id = if $has_user { "user-" + random_int(seed: $seed, min: 1000, max: 9999).string() } else { null }

        let paths = ["/api/users", "/api/orders", "/api/profile", "/login", "/health"]
        let path = $paths.index(random_int(seed: $seed, max: 4))

        root._raw = "%s - %s [%s] \"GET %s HTTP/1.1\" 200 %s".format(
          $ip,
          if $user_id != null { $user_id } else { "-" },
          now().ts_strftime("%d/%b/%Y:%H:%M:%S -0800"),
          $path,
          random_int(seed: $seed, min: 100, max: 50000).string()
        )

        root.host = hostname()
        root.source = "/var/log/httpd/access_log"
        root.sourcetype = "access_combined"
        root.region = $region
        root.clientip = $ip
        root.user_id = $user_id
        root.has_pii = $user_id != null

  pipeline:
    processors:
      - bloblang: |
          meta "region" = this.region
          meta "has_pii" = this.has_pii

          # GDPR Compliance Logic:
          # - EU data with PII MUST stay in EU
          # - EU data without PII CAN go to US (for cost savings)
          # - US/APAC data always goes to US

          meta "destination" = if meta("region") == "eu" && meta("has_pii") {
            "eu-storage"
          } else {
            "us-storage"
          }

          meta "compliance_note" = if meta("region") == "eu" && meta("has_pii") {
            "GDPR: PII data retained in EU"
          } else if meta("region") == "eu" {
            "EU non-PII routed to US"
          } else {
            "Non-EU data routed to US"
          }

          meta "sourcetype" = this.sourcetype
          meta "host" = this.host
          meta "source" = this.source

          root = this

  output:
    switch:
      cases:
        # EU Storage - GDPR compliant
        - check: meta("destination") == "eu-storage"
          output:
            processors:
              - bloblang: |
                  root.event = this._raw
                  root.time = now().ts_unix()
                  root.host = meta("host")
                  root.source = meta("source")
                  root.sourcetype = meta("sourcetype")
                  root.index = "eu_main"
                  root.fields = {
                    "region": meta("region"),
                    "compliance": meta("compliance_note"),
                    "has_pii": meta("has_pii").string()
                  }
            http_client:
              url: http://hec:8088/services/collector/event
              verb: POST
              headers:
                Authorization: "Splunk demo"
                Content-Type: application/json

        # US Storage - default destination
        - check: true
          output:
            processors:
              - bloblang: |
                  root.event = this._raw
                  root.time = now().ts_unix()
                  root.host = meta("host")
                  root.source = meta("source")
                  root.sourcetype = meta("sourcetype")
                  root.index = "us_main"
                  root.fields = {
                    "region": meta("region"),
                    "compliance": meta("compliance_note"),
                    "has_pii": meta("has_pii").string()
                  }
            http_client:
              url: http://hec:8088/services/collector/event
              verb: POST
              headers:
                Authorization: "Splunk demo"
                Content-Type: application/json
