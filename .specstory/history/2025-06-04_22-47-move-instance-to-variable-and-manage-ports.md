<!-- Generated by SpecStory -->

# Move instance to variable and manage ports (2025-06-04 15:47:26)

_**User**_

move the instance to a variable at the top of the script. 

if the ports are already open ask to kill the processes, and exit if no.

 ps aux | grep ssm
daaronch         26364   0.0  0.0 410724448   1424 s005  S+    3:47PM   0:00.00 grep ssm
daaronch         21980   0.0  0.0 411945008  26096 s005  S     3:45PM   0:00.49 session-manager-plugin AWS_SSM_START_SESSION_RESPONSE us-east-1 StartSession  {"Target": "i-017e196cd2e5cd005", "DocumentName": "AWS-StartPortForwardingSession", "Parameters": {"portNumber": ["8000"], "localPortNumber": ["8000"]}} https://ssm.us-east-1.amazonaws.com
daaronch         21954   0.0  0.0 411927184  21376 s005  S     3:45PM   0:00.14 session-manager-plugin AWS_SSM_START_SESSION_RESPONSE us-east-1 StartSession  {"Target": "i-017e196cd2e5cd005", "DocumentName": "AWS-StartPortForwardingSession", "Parameters": {"portNumber": ["1234"], "localPortNumber": ["1234"]}} https://ssm.us-east-1.amazonaws.com
daaronch         21906   0.0  0.1 411889184  85744 s005  S     3:45PM   0:00.38 /opt/homebrew/Cellar/python@3.13/3.13.3_1/Frameworks/Python.framework/Versions/3.13/Resources/Python.app/Contents/MacOS/Python /opt/homebrew/bin/aws ssm start-session --target i-017e196cd2e5cd005 --document-name AWS-StartPortForwardingSession --parameters {"portNumber":["8000"],"localPortNumber":["8000"]} --region us-east-1
daaronch         21652   0.0  0.2 412294688 119152 s005  S     3:45PM   0:01.19 /opt/homebrew/Cellar/python@3.13/3.13.3_1/Frameworks/Python.framework/Versions/3.13/Resources/Python.app/Contents/MacOS/Python /opt/homebrew/bin/aws ssm start-session --target i-017e196cd2e5cd005 --document-name AWS-StartPortForwardingSession --parameters {"portNumber":["1234"],"localPortNumber":["1234"]} --region us-east-1

---

_**Assistant**_



---

I'll help you move the instance ID to a variable and add a check for existing SSM sessions. Let me make these changes to your script.

---

```diff
  # --- Configuration ---
  SESSION_NAME="my_dev_session"
+ INSTANCE_ID="i-017e196cd2e5cd005"  # EC2 instance ID for SSM sessions
  # Directory to store PID files and logs
  STATE_DIR="$HOME/.${SESSION_NAME}"
```

```diff
  MANAGED_COMMANDS=(
      ["ssh_to_ec2"]="ssh -N ec2-user@54.83.82.74" # -N: Do not execute a remote command (for backgrounding)
-     ["ssm_port_8000"]="aws ssm start-session --target i-017e196cd2e5cd005 --document-name AWS-StartPortForwardingSession --parameters '{\"portNumber\":[\"8000\"],\"localPortNumber\":[\"8000\"]}' --region us-east-1"
-     ["ssm_port_1234"]="aws ssm start-session --target i-017e196cd2e5cd005 --document-name AWS-StartPortForwardingSession --parameters '{\"portNumber\":[\"1234\"],\"localPortNumber\":[\"1234\"]}' --region us-east-1"
-     ["ssm_general_session"]="aws ssm start-session --target i-017e196cd2e5cd005 --region us-east-1"
+     ["ssm_port_8000"]="aws ssm start-session --target $INSTANCE_ID --document-name AWS-StartPortForwardingSession --parameters '{\"portNumber\":[\"8000\"],\"localPortNumber\":[\"8000\"]}' --region us-east-1"
+     ["ssm_port_1234"]="aws ssm start-session --target $INSTANCE_ID --document-name AWS-StartPortForwardingSession --parameters '{\"portNumber\":[\"1234\"],\"localPortNumber\":[\"1234\"]}' --region us-east-1"
+     ["ssm_general_session"]="aws ssm start-session --target $INSTANCE_ID --region us-east-1"
  )
  
```

---



---

Now I'll add a function to check for existing SSM sessions and prompt the user:

---

```diff
      mkdir -p "$LOG_DIR"
  }
+ 
+ # Check for existing SSM sessions and prompt user
+ check_existing_ssm_sessions() {
+     # Check for existing SSM sessions
+     local ssm_processes=$(ps aux | grep -E "ssm start-session.*$INSTANCE_ID" | grep -v grep)
+     
+     if [ -n "$ssm_processes" ]; then
+         echo "‚ö†Ô∏è  Found existing SSM sessions running:"
+         echo ""
+         
+         # Display the processes
+         echo "$ssm_processes" | while IFS= read -r line; do
+             local pid=$(echo "$line" | awk '{print $2}')
+             local port=$(echo "$line" | grep -oE 'localPortNumber":\["[0-9]+"\]' | grep -oE '[0-9]+' || echo "N/A")
+             if [ "$port" != "N/A" ]; then
+                 echo "   - PID $pid: Port forwarding on port $port"
+             else
+                 echo "   - PID $pid: General SSM session"
+             fi
+         done
+         
+         echo ""
+         read -p "Do you want to kill these existing SSM sessions? (y/N): " -n 1 -r
+         echo ""
+         
+         if [[ ! $REPLY =~ ^[Yy]$ ]]; then
+             echo "‚ùå Exiting without starting new services."
+             echo "   You can manually kill the processes or use '$0 stop' if they were started by this script."
+             exit 0
+         else
+             echo "üî™ Killing existing SSM sessions..."
+             echo "$ssm_processes" | awk '{print $2}' | while read pid; do
+                 echo "   Killing PID $pid..."
+                 kill "$pid" 2>/dev/null || true
+             done
+             
+             # Wait a moment for processes to terminate
+             sleep 2
+             
+             # Check if any are still running and force kill if necessary
+             local remaining=$(ps aux | grep -E "ssm start-session.*$INSTANCE_ID" | grep -v grep)
+             if [ -n "$remaining" ]; then
+                 echo "   Some processes still running, force killing..."
+                 echo "$remaining" | awk '{print $2}' | while read pid; do
+                     kill -9 "$pid" 2>/dev/null || true
+                 done
+                 sleep 1
+             fi
+             
+             echo "‚úÖ Existing SSM sessions terminated."
+             echo ""
+         fi
+     fi
+ }
  
  # --- Main Functions ---
```

---



---

Now I'll add the call to check for existing SSM sessions in the start_services function:

---

```diff
  start_services() {
      ensure_dirs
+     
+     # Check for existing SSM sessions before proceeding
+     check_existing_ssm_sessions
+     
      if [ -f "$COMMAND_PIDS_FILE" ] && [ -s "$COMMAND_PIDS_FILE" ]; then
          echo "‚ö†Ô∏è Services might already be running (PID file exists and is not empty)."
```

---



---

Let me also enhance the function to check for session-manager-plugin processes which are the actual processes handling the port forwarding:

---

```diff
  # Check for existing SSM sessions and prompt user
  check_existing_ssm_sessions() {
-     # Check for existing SSM sessions
-     local ssm_processes=$(ps aux | grep -E "ssm start-session.*$INSTANCE_ID" | grep -v grep)
+     # Check for existing SSM sessions (both aws ssm commands and session-manager-plugin)
+     local ssm_processes=$(ps aux | grep -E "(ssm start-session.*$INSTANCE_ID|session-manager-plugin.*$INSTANCE_ID)" | grep -v grep)
      
      if [ -n "$ssm_processes" ]; then
```

```diff
          echo "$ssm_processes" | while IFS= read -r line; do
              local pid=$(echo "$line" | awk '{print $2}')
-             local port=$(echo "$line" | grep -oE 'localPortNumber":\["[0-9]+"\]' | grep -oE '[0-9]+' || echo "N/A")
+             local port=$(echo "$line" | grep -oE 'localPortNumber":\s*\["[0-9]+"\]' | grep -oE '[0-9]+' || echo "N/A")
+             local process_type="SSM session"
+             
+             if echo "$line" | grep -q "session-manager-plugin"; then
+                 process_type="Session Manager Plugin"
+             fi
+             
              if [ "$port" != "N/A" ]; then
-                 echo "   - PID $pid: Port forwarding on port $port"
+                 echo "   - PID $pid ($process_type): Port forwarding on port $port"
              else
-                 echo "   - PID $pid: General SSM session"
+                 echo "   - PID $pid ($process_type): General session"
              fi
          done
```

```diff
              
              # Check if any are still running and force kill if necessary
-             local remaining=$(ps aux | grep -E "ssm start-session.*$INSTANCE_ID" | grep -v grep)
+             local remaining=$(ps aux | grep -E "(ssm start-session.*$INSTANCE_ID|session-manager-plugin.*$INSTANCE_ID)" | grep -v grep)
              if [ -n "$remaining" ]; then
                  echo "   Some processes still running, force killing..."
```

---



---

Perfect! I've made the requested changes to your script:

1. **Moved the instance ID to a variable**: Added `INSTANCE_ID="i-017e196cd2e5cd005"` at the top of the script in the configuration section.

2. **Added port conflict detection**: Created a new function `check_existing_ssm_sessions` that:
   - Checks for both `aws ssm` commands and `session-manager-plugin` processes running with your instance ID
   - Displays which ports are being forwarded
   - Prompts the user to kill existing sessions
   - Exits if the user chooses not to kill them (answers 'N' or just presses Enter)
   - Kills the processes if the user confirms with 'y' or 'Y'

3. **Integrated the check**: The `start_services` function now calls `check_existing_ssm_sessions` before attempting to start new services.

Now when you run `./manage_session.sh start`, if there are existing SSM sessions, you'll see something like:

```
‚ö†Ô∏è  Found existing SSM sessions running:

   - PID 21980 (Session Manager Plugin): Port forwarding on port 8000
   - PID 21954 (Session Manager Plugin): Port forwarding on port 1234
   - PID 21906 (SSM session): Port forwarding on port 8000
   - PID 21652 (SSM session): Port forwarding on port 1234

Do you want to kill these existing SSM sessions? (y/N): 
```

If you type 'n' or just press Enter, the script will exit without starting new services. If you type 'y', it will kill the existing processes and then proceed with starting the new services.

---

