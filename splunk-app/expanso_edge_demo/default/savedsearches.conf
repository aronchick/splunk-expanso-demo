#
# Saved Searches for Expanso Edge Demo
# Pre-built searches for monitoring and alerting on edge pipeline data
#

#
# Overview Searches
#

[Expanso Edge - Event Volume by Index]
search = index=web OR index=security OR index=os OR index=metrics OR index=us_main OR index=eu_main \
| stats count by index \
| sort - count
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 * * * *
enableSched = 1
description = Shows event volume across all Expanso Edge indexes

[Expanso Edge - Events by Host]
search = index=web OR index=security OR index=os \
| stats count by host \
| sort - count \
| head 20
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Top 20 hosts by event volume in the last hour

[Expanso Edge - Events by Region]
search = index=us_main OR index=eu_main \
| eval region=if(index="eu_main", "EU", "US") \
| stats count by region \
| sort - count
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
description = Event distribution by geographic region

#
# Web Traffic Searches
#

[Expanso Edge - HTTP Status Codes]
search = index=web sourcetype=access_combined \
| rex field=_raw "HTTP/1\.[01]\" (?<status>\d+)" \
| stats count by status \
| sort - count
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Distribution of HTTP status codes

[Expanso Edge - Top URLs]
search = index=web sourcetype=access_combined \
| rex field=_raw "\"(?:GET|POST|PUT|DELETE) (?<uri>[^\s]+)" \
| stats count by uri \
| sort - count \
| head 20
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Top 20 requested URLs in the last hour

[Expanso Edge - Error Responses]
search = index=web sourcetype=access_combined \
| rex field=_raw "HTTP/1\.[01]\" (?<status>\d+)" \
| where status >= 400 \
| stats count by status, host \
| sort - count
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = HTTP 4xx and 5xx errors by status and host

#
# Security Searches
#

[Expanso Edge - Failed Logins]
search = index=security sourcetype=apache_error "Failed" OR "failed" OR "unauthorized" \
| stats count by host \
| sort - count
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
description = Failed login attempts by host

[Expanso Edge - Security Events by Severity]
search = index=security \
| rex field=_raw "\[(?<level>\w+)\]" \
| stats count by level \
| sort - count
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Security events grouped by severity level

[Alert - High Error Rate]
search = index=security sourcetype=apache_error level=error OR level=crit \
| stats count as error_count \
| where error_count > 100
dispatch.earliest_time = -15m@m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1
alert.severity = 4
alert.track = 1
alert_condition = search error_count > 100
action.email = 0
description = Alerts when error count exceeds threshold in 15 minutes

#
# GDPR Compliance Searches
#

[Expanso Edge - GDPR Data Distribution]
search = index=eu_main OR index=us_main \
| eval compliance=if(index="eu_main", "GDPR Compliant (EU Storage)", "Standard (US Storage)") \
| stats count by compliance \
| sort - count
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
description = Shows data distribution between GDPR-compliant and standard storage

[Expanso Edge - EU PII Events]
search = index=eu_main has_pii=true \
| stats count by host \
| sort - count
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
description = EU events containing PII data (retained in EU storage)

#
# Infrastructure Metrics
#

[Expanso Edge - IoT Sensor Summary]
search = index=metrics sourcetype="iot:sensor:aggregated" \
| stats avg(readings.avg_temperature_c) as avg_temp, \
        avg(readings.avg_humidity_pct) as avg_humidity, \
        sum(event_count) as total_events by sensor_id \
| sort - total_events
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Summary of IoT sensor readings

[Expanso Edge - Aggregation Efficiency]
search = index=metrics sourcetype="iot:sensor:aggregated" \
| stats sum(event_count) as raw_events, count as aggregated_events \
| eval reduction_pct = round((1 - (aggregated_events / raw_events)) * 100, 2) \
| table raw_events, aggregated_events, reduction_pct
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Shows the efficiency of edge aggregation (events reduced)

#
# Fleet Monitoring
#

[Expanso Edge - Active Nodes]
search = index=web OR index=security OR index=os OR index=metrics \
| stats dc(host) as unique_hosts, count as total_events \
| eval events_per_host = round(total_events / unique_hosts, 0)
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Count of active edge nodes and event distribution

[Expanso Edge - Node Health]
search = index=web OR index=security OR index=os \
| bucket _time span=5m \
| stats count by host, _time \
| streamstats window=3 avg(count) as avg_count by host \
| eval health=if(count < (avg_count * 0.5), "degraded", "healthy") \
| stats latest(health) as current_health by host
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
description = Node health based on event volume consistency

[Alert - Node Offline]
search = index=web OR index=security OR index=os \
| stats latest(_time) as last_seen by host \
| eval minutes_since = round((now() - last_seen) / 60, 0) \
| where minutes_since > 10 \
| table host, minutes_since
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
cron_schedule = */5 * * * *
enableSched = 1
alert.severity = 5
alert.track = 1
alert_condition = search minutes_since > 10
action.email = 0
description = Alerts when an edge node stops sending data for more than 10 minutes
