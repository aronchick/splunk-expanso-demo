<dashboard version="1.1" theme="dark">
  <label>Fleet Status</label>
  <description>Monitor health and status of all Expanso Edge nodes</description>

  <row>
    <panel>
      <title>Active Nodes</title>
      <single>
        <search>
          <query>index=web OR index=security OR index=os | stats dc(host) as nodes</query>
          <earliest>-15m@m</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
      </single>
    </panel>
    <panel>
      <title>US Nodes</title>
      <single>
        <search>
          <query>index=web OR index=security OR index=os | search host="*-us-*" | stats dc(host)</query>
          <earliest>-15m@m</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <title>EU Nodes</title>
      <single>
        <search>
          <query>index=web OR index=security OR index=os | search host="*-eu-*" | stats dc(host)</query>
          <earliest>-15m@m</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <title>APAC Nodes</title>
      <single>
        <search>
          <query>index=web OR index=security OR index=os | search host="*-ap-*" | stats dc(host)</query>
          <earliest>-15m@m</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>Events by Node</title>
      <chart>
        <search>
          <query>index=web OR index=security OR index=os | timechart span=5m count by host</query>
          <earliest>-1h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Node Health Status</title>
      <table>
        <search>
          <query>index=web OR index=security OR index=os
| stats count, latest(_time) as last_seen by host
| eval minutes_ago = round((now() - last_seen) / 60, 1)
| eval status = case(
    minutes_ago &lt; 2, "Healthy",
    minutes_ago &lt; 5, "Warning",
    1=1, "Critical"
  )
| eval events_per_min = round(count / 60, 1)
| table host, status, events_per_min, minutes_ago
| sort status, - events_per_min</query>
          <earliest>-1h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">cell</option>
        <format type="color" field="status">
          <colorPalette type="map">{"Healthy":#65a637,"Warning":#f8be34,"Critical":#dc4e41}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>Events by Region</title>
      <chart>
        <search>
          <query>index=web OR index=security OR index=os
| eval region = case(
    match(host, "-us-"), "US",
    match(host, "-eu-"), "EU",
    match(host, "-ap-"), "APAC",
    1=1, "Unknown"
  )
| stats count by region</query>
          <earliest>-1h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Node Activity Heatmap</title>
      <chart>
        <search>
          <query>index=web OR index=security OR index=os
| bucket _time span=10m
| stats count by host, _time
| xyseries _time host count</query>
          <earliest>-4h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>
</dashboard>
